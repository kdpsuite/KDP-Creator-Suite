name: Flutter Build and Release

on:
  workflow_dispatch:   # allows manual triggers
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # gives bot write permission for push/changes

    env:
      FLUTTER_VERSION: "3.37.0-0.1.pre"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # Install Flutter manually
      # ------------------------------
      - name: Install Flutter
        run: |
          git clone -b $FLUTTER_VERSION https://github.com/flutter/flutter.git /home/runner/flutter
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter --version

      # ------------------------------
      # Run project fix scripts
      # ------------------------------
      - name: Run project fix scripts
        run: |
          chmod +x mobile-app/scripts/fix_files.sh
          ./mobile-app/scripts/fix_files.sh
        working-directory: .

      # ------------------------------
      # Check outdated Dart & Flutter packages
      # ------------------------------
      - name: üîç Check outdated Dart & Flutter packages
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          echo "Switching to beta channel for stability..."
          flutter channel beta
          flutter upgrade
          
          echo "Checking Dart packages..."
          dart pub outdated || true
          
          echo "Checking Flutter packages..."
          flutter pub outdated || true
          
          echo "Upgrading Flutter packages to latest major versions..."
          flutter pub upgrade --major-versions
        working-directory: mobile-app

      # ------------------------------
      # Get Flutter dependencies
      # ------------------------------
      - name: Get Flutter dependencies
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter pub get
        working-directory: mobile-app

      # ------------------------------
      # Auto versioning & build numbering
      # ------------------------------
      - name: Auto Versioning
        run: |
          ./mobile-app/scripts/auto_version.sh
        working-directory: .

      # ------------------------------
      # Build Debug APK
      # ------------------------------
      - name: Build Debug APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --debug --build-number=$GITHUB_RUN_NUMBER
        working-directory: mobile-app

      # ------------------------------
      # Build Release APK
      # ------------------------------
      - name: Build Release APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --release --build-number=$GITHUB_RUN_NUMBER
        working-directory: mobile-app

      # ------------------------------
      # Zip APKs
      # ------------------------------
      - name: Zip APKs
        run: |
          mkdir -p artifacts
          zip -r artifacts/kdp_apks.zip build/app/outputs/flutter-apk/*.apk
        working-directory: mobile-app

      # ------------------------------
      # Upload artifact
      # ------------------------------
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: kdp_apks
          path: mobile-app/artifacts/kdp_apks.zip
