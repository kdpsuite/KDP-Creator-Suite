name: Flutter Build APKs

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: "3.13.0" # Match your project Dart SDK requirement

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install Flutter manually
        run: |
          git clone -b $FLUTTER_VERSION https://github.com/flutter/flutter.git /home/runner/flutter
          echo "/home/runner/flutter/bin" >> $GITHUB_PATH
          flutter --version

      - name: Run project fix scripts
        run: |
          chmod +x mobile-app/scripts/fix_files.sh
          ./mobile-app/scripts/fix_files.sh

      - name: Get Flutter dependencies
        run: |
          flutter pub get
        working-directory: mobile-app

      - name: Auto version/build bump
        run: |
          cd mobile-app
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          VERSION_NAME=$(grep version: pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
          BUILD_NUMBER=$(grep version: pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
          NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
          sed -i "s/version: .*/version: ${VERSION_NAME}+${NEW_BUILD_NUMBER}/" pubspec.yaml
          echo "Updated build number to ${NEW_BUILD_NUMBER}"

          git add pubspec.yaml
          git commit -m "CI: Bump build number to ${NEW_BUILD_NUMBER} [skip ci]"
          git push origin HEAD:${{ github.ref }}

      - name: Build Debug APK
        run: |
          flutter build apk --debug --build-name=$VERSION_NAME --build-number=$NEW_BUILD_NUMBER
        working-directory: mobile-app

      - name: Build Release APK
        run: |
          flutter build apk --release --build-name=$VERSION_NAME --build-number=$NEW_BUILD_NUMBER
        working-directory: mobile-app

      - name: Zip APKs
        run: |
          mkdir -p artifacts
          cp mobile-app/build/app/outputs/flutter-apk/app-debug.apk artifacts/
          cp mobile-app/build/app/outputs/flutter-apk/app-release.apk artifacts/
          cd artifacts
          zip -r kdp_apks.zip *
        working-directory: ${{ github.workspace }}

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: kdp_apks
          path: artifacts/kdp_apks.zip
