name: Build APKs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ------------------------------
      # Install the correct Flutter version
      # ------------------------------
      - name: 🛠️ Install Flutter 3.13.x (Dart >= 3.10)
        run: |
          git clone https://github.com/flutter/flutter.git /home/runner/flutter
          cd /home/runner/flutter
          git fetch --all --tags
          git checkout 3.13.0
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter --version

      # ------------------------------
      # Run project fix scripts
      # ------------------------------
      - name: Run project fix scripts
        run: |
          echo "Running fix_files.sh (will NOT change working directory inside the script)..."
          chmod +x mobile-app/scripts/fix_files.sh
          ./mobile-app/scripts/fix_files.sh

      # ------------------------------
      # Get Flutter dependencies
      # ------------------------------
      - name: 📦 Get Flutter dependencies
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter pub get
        working-directory: mobile-app

      # ------------------------------
      # Automatic versioning & build number
      # ------------------------------
      - name: 🔢 Set version and build number
        id: versioning
        run: |
          # Example: using Git commits count as build number
          BUILD_NUMBER=$(git rev-list --count HEAD)
          VERSION_NAME="1.0.$BUILD_NUMBER"
          echo "Version: $VERSION_NAME, Build: $BUILD_NUMBER"
          
          # Update pubspec.yaml
          sed -i "s/^version: .*/version: $VERSION_NAME+$BUILD_NUMBER/" mobile-app/pubspec.yaml
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      # ------------------------------
      # Build APKs
      # ------------------------------
      - name: Build Debug APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --debug
        working-directory: mobile-app

      - name: Build Release APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --release
        working-directory: mobile-app

      # ------------------------------
      # Zip both APKs
      # ------------------------------
      - name: 📦 Zip APKs
        run: |
          mkdir -p release_apks
          cp mobile-app/build/app/outputs/flutter-apk/app-debug.apk release_apks/
          cp mobile-app/build/app/outputs/flutter-apk/app-release.apk release_apks/
          zip -r release_apks.zip release_apks

      # ------------------------------
      # Upload zipped APKs
      # ------------------------------
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: release_apks.zip
