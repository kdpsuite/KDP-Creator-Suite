name: Flutter Build & Repair

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    env:
      FLUTTER_VERSION: "3.37.0-0.1.pre"
      PROJECT_ROOT: ${{ github.workspace }}
      MOBILE_APP: ${{ github.workspace }}/mobile-app

    steps:

      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Run Project Fix Scripts
        run: |
          chmod +x $MOBILE_APP/scripts/fix_files.sh
          chmod +x $MOBILE_APP/scripts/fix_app_theme_imports.sh
          $MOBILE_APP/scripts/fix_files.sh
          $MOBILE_APP/scripts/fix_app_theme_imports.sh

      - name: Commit fixed files
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add $MOBILE_APP
          git commit -m "Apply automated AppTheme and project fixes" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed (branch protection?)"

      - name: Install Flutter manually
        run: |
          git clone -b $FLUTTER_VERSION https://github.com/flutter/flutter.git $HOME/flutter
          export PATH="$PATH:$HOME/flutter/bin"
          flutter doctor -v

      - name: Switch Flutter to Beta Channel & Upgrade
        run: |
          export PATH="$PATH:$HOME/flutter/bin"
          flutter channel beta
          flutter upgrade

      - name: Check Dart & Flutter packages
        run: |
          export PATH="$PATH:$HOME/flutter/bin"
          cd $MOBILE_APP
          flutter pub outdated
          dart pub outdated
          flutter pub upgrade --major-versions
          flutter pub get

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Run Flutter Doctor & Clean Project
        run: |
          export PATH="$PATH:$HOME/flutter/bin"
          cd $MOBILE_APP
          flutter doctor -v
          flutter clean

      - name: Build Debug APK
        run: |
          export PATH="$PATH:$HOME/flutter/bin"
          cd $MOBILE_APP
          flutter build apk --debug --verbose

      - name: Build Release APK
        run: |
          export PATH="$PATH:$HOME/flutter/bin"
          cd $MOBILE_APP
          flutter build apk --release --verbose

      - name: Automatic Versioning & Build Number
        run: |
          cd $MOBILE_APP
          VERSION_CODE=$(date +%s)
          VERSION_NAME=$(git rev-parse --short HEAD)
          echo "version: $VERSION_NAME+$VERSION_CODE" > version.txt

      - name: Zip APKs
        run: |
          cd $MOBILE_APP/build/app/outputs/flutter-apk
          zip -r debug_apk.zip app-debug.apk
          zip -r release_apk.zip app-release.apk

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: APKs
          path: |
            $MOBILE_APP/build/app/outputs/flutter-apk/debug_apk.zip
            $MOBILE_APP/build/app/outputs/flutter-apk/release_apk.zip
