name: Flutter Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Give bot write access for pushing fixes/scripts

    env:
      FLUTTER_VERSION: "3.37.0-0.1.pre" # Flutter version matching Dart SDK requirement

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip xz-utils git curl

      - name: Install Flutter manually
        run: |
          git clone -b $FLUTTER_VERSION https://github.com/flutter/flutter.git /home/runner/flutter
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter --version

      - name: Run project fix scripts
        run: |
          echo "Running fix_files.sh (will NOT change working directory inside the script)..."
          chmod +x mobile-app/scripts/fix_files.sh
          ./mobile-app/scripts/fix_files.sh
        continue-on-error: true

      - name: üîç Check outdated Dart & Flutter packages
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          echo "Switching to beta channel for stability..."
          flutter channel beta
          flutter doctor

          echo "Checking Dart packages..."
          dart pub outdated || true

          echo "Checking Flutter packages..."
          flutter pub outdated || true

          echo "Upgrading Flutter packages to latest major versions..."
          flutter pub upgrade --major-versions
        working-directory: mobile-app

      - name: Get Flutter dependencies
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter pub get
        working-directory: mobile-app

      - name: Build Debug APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --debug --build-number=$GITHUB_RUN_NUMBER
        working-directory: mobile-app

      - name: Build Release APK
        run: |
          export PATH="$PATH:/home/runner/flutter/bin"
          flutter build apk --release --build-number=$GITHUB_RUN_NUMBER
        working-directory: mobile-app

      - name: Zip APKs
        run: |
          mkdir -p build_artifacts
          zip -r build_artifacts/kdp_creator_suite_debug.apk.zip build/app/outputs/flutter-apk/app-debug.apk
          zip -r build_artifacts/kdp_creator_suite_release.apk.zip build/app/outputs/flutter-apk/app-release.apk

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: kdp_creator_suite_apks
          path: build_artifacts
