name: Flutter CI/CD

on:
  workflow_dispatch: # manual trigger
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      FLUTTER_VERSION: "3.37.0-0.1.pre" # matches your SDK requirement

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git for workflow
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y unzip xz-utils zip git curl

    - name: Clone Flutter manually
      run: |
        git clone -b beta https://github.com/flutter/flutter.git /home/runner/flutter
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter doctor

    - name: Flutter upgrade
      run: |
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter channel beta
        flutter upgrade

    - name: Check outdated Dart/Flutter packages
      run: |
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter pub outdated
        flutter pub upgrade --major-versions

    - name: Run project fix scripts
      run: |
        chmod +x mobile-app/scripts/fix_files.sh
        chmod +x mobile-app/scripts/fix_app_theme_imports.sh
        ./mobile-app/scripts/fix_files.sh
        ./mobile-app/scripts/fix_app_theme_imports.sh

    - name: Push fixed files back to repo
      run: |
        git add .
        git diff-index --quiet HEAD || git commit -m "ðŸ’„ Auto-fix AppTheme imports and permissions"
        git push origin HEAD

    - name: Get Flutter dependencies
      run: |
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter pub get

    - name: Set build number and version automatically
      run: |
        BUILD_NUMBER=$(date +%s)
        flutter pub run version:main --build-number=$BUILD_NUMBER

    - name: Build Debug APK
      run: |
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter build apk --debug --build-number=$BUILD_NUMBER

    - name: Build Release APK
      run: |
        export PATH="$PATH:/home/runner/flutter/bin"
        flutter build apk --release --build-number=$BUILD_NUMBER

    - name: Zip APKs
      run: |
        mkdir -p artifacts
        zip -r artifacts/kdp_apks.zip build/app/outputs/flutter-apk/

    - name: Upload APKs artifact
      uses: actions/upload-artifact@v4
      with:
        name: kdp_apks
        path: artifacts/kdp_apks.zip
