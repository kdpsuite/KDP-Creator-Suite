name: 🏗️ Build Flutter APKs

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - beta
      - dev

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Set up Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 🧱 Ensure scripts folder exists
        run: |
          mkdir -p mobile-app/scripts
          echo "✅ Verified mobile-app/scripts folder exists."

      - name: 🔒 Make scripts executable
        run: chmod +x mobile-app/scripts/*.sh || true

      - name: 🛠️ Manually install Flutter
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git curl unzip xz-utils zip libglu1-mesa
          git clone https://github.com/flutter/flutter.git -b beta
          export PATH="$PATH:$PWD/flutter/bin"
          flutter doctor -v

      - name: 🔄 Full Flutter upgrade (before pub get)
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          flutter upgrade || true

      - name: 🔁 Switch to Flutter beta channel for stability
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          flutter channel beta
          flutter upgrade || true
          flutter doctor -v

      - name: 📦 Check for outdated packages (Dart + Flutter)
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          cd mobile-app
          dart pub outdated || true
          flutter pub outdated || true
          flutter pub upgrade --major-versions || true

      - name: 🧹 Run AppTheme import fix
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          ./mobile-app/scripts/fix_app_theme_imports.sh

      - name: 🧩 Run Flutter file repair
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          ./mobile-app/scripts/fix_files.sh

      - name: 💾 Commit and push any fixed files
        run: |
          git add .
          git commit -m "🩹 Auto-fixed AppTheme imports and repaired files" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: 📲 Get Flutter dependencies
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          cd mobile-app
          flutter pub get

      - name: 🧮 Auto-increment version/build numbers
        run: |
          cd mobile-app
          if [ -f pubspec.yaml ]; then
            VERSION_LINE=$(grep '^version: ' pubspec.yaml)
            VERSION_NUMBER=$(echo "$VERSION_LINE" | cut -d+ -f1 | cut -d' ' -f2)
            BUILD_NUMBER=$(echo "$VERSION_LINE" | cut -d+ -f2)
            NEW_BUILD_NUMBER=$((BUILD_NUMBER + 1))
            NEW_VERSION="${VERSION_NUMBER}+${NEW_BUILD_NUMBER}"
            sed -i "s/^version: .*/version: ${NEW_VERSION}/" pubspec.yaml
            echo "📈 Version bumped to $NEW_VERSION"
          fi

      - name: ⚙️ Build Flutter APKs (Debug + Release)
        run: |
          export PATH="$PATH:$PWD/flutter/bin"
          cd mobile-app
          flutter build apk --debug
          flutter build apk --release

      - name: 📦 Zip APKs
        run: |
          cd mobile-app/build/app/outputs/flutter-apk
          zip -r ../../../../KDP_Creator_Suite_APKs.zip ./*.apk

      - name: 🚀 Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: KDP_Creator_Suite_APKs
          path: mobile-app/build/app/outputs/KDP_Creator_Suite_APKs.zip
